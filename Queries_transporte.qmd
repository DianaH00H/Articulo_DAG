---
title: "Queries_Transporte"
author: "José Alfredo López Torres"
format: 
    html:
      toc: true
      html-math-method: katex
      embed-resources: true
      self-contained-math: true
      df-print: kable
editor: source
---

Establecemos semillas y librerias

```{r}
set.seed(1234)
library(bnlearn)
```

Primero que nada voy e elegir mis variables segun el query que me tocó.

### Query

¿Cuál es la probabilidad de que el automóvil sea el medio de transporte de un hombre, dado que su propósito de viaje es ir a un acto religioso?

### Cargamos datos

```{r}
data = read.csv('data/base_unida.csv',stringsAsFactors = TRUE)

head(data)

```

Arreglamos las variables para que los queries funcionen

```{r}
# Variables categóricas
vars_factor <- c("tra_sexo", "via_p5_13", "tra_p5_14",
                 "tra_p5_3", "tra_estrato", "tra_p5_17_1c",
                 "via_p5_6", "via_p5_11a", "via_p5_14_18")
data[vars_factor] <- lapply(data[vars_factor], as.factor)

# Crear variable binaria de duración (>1 hora)
data$dur_60 <- ifelse(data$tra_p5_16_1_1 > 1, "Mayor_1h", "Menor_igual_1h")
data$dur_60 <- factor(data$dur_60)

# Variables derivadas de tra_p5_14 siendo estas: Automovil, Motorizado, modo_ok
data$automovil <- ifelse(data$tra_p5_14 == 1, "Automovil", "No_Automovil") #saber si utiliza automovil
data$automovil <- factor(data$automovil)

data$motorizado <- ifelse(data$tra_p5_14 %in% 
                            c(1,2,3,4,5,6,8,9,10,11,12,13,15,17,18,19,20), 
                          "Motorizado", "No_motorizado") #saber si utiliza un vehiculo motorizado para viajar o no
data$motorizado <- factor(data$motorizado)

data$modo_ok <- ifelse(data$tra_p5_14 %in% c(6,12,13),
                       as.character(data$tra_p5_14), "Otro") #identificar si utiliza transporte publico u otro vehiculo
data$modo_ok <- factor(data$modo_ok)

# Eliminar la columna original para evitar conflictos
data$tra_p5_14 <- NULL
data$tra_p5_16_1_1 <- NULL

```

Asignamos nombres más apropiados a las variables

```{r}
names(data)[names(data) == "tra_sexo"]     <- "sexo"
names(data)[names(data) == "via_p5_13"]    <- "acto_religioso"
names(data)[names(data) == "tra_estrato"]  <- "estrato_alto"
names(data)[names(data) == "tra_p5_17_1c"] <- "st_cuauh"
names(data)[names(data) == "tra_p5_3"]     <- "es_sabado"
names(data)[names(data) == "via_p5_6"]     <- "origen"
names(data)[names(data) == "via_p5_11a"]   <- "destino"
names(data)[names(data) == "via_p5_14_18"] <- "transporte_escolar"

head(data)
```

### Dag

```{r}
dag = empty.graph(nodes = c('sexo',
'acto_religioso',
'automovil',
'motorizado',
'dur_60',
'es_sabado',
'estrato_alto',
'modo_ok',
'st_cuauh',
'origen',
'destino',
'transporte_escolar'
))
```

```{r}
arc_set = matrix(c('sexo', 'destino',
                   'sexo', 'automovil',
                   'estrato_alto', 'destino',
                   'estrato_alto', 'origen',
                   'estrato_alto', 'st_cuauh',
                   'estrato_alto', 'automovil',
                   'estrato_alto', 'modo_ok',
                   'acto_religioso', 'destino',
                   'acto_religioso', 'automovil',
                   'destino', 'es_sabado',
                   'destino', 'automovil',
                   'destino', 'motorizado',
                   'destino', 'transporte_escolar',
                   'origen', 'st_cuauh',
                   'origen', 'modo_ok',
                   'automovil', 'dur_60',
                   'motorizado', 'dur_60',
                   'modo_ok', 'dur_60'),byrow = TRUE, ncol = 2,
                 dimnames = list(NULL, c('from', 'to')))

arcs(dag) = arc_set
dag

```

```{r}
graphviz.plot(dag, shape = "ellipse")
```

### Red Bayesiana

```{r}
bn_mle = bn.fit(dag, data=data, method = 'mle')
```

```{r}
bn_mle
```

Probamos la significancia de las relaciones

```{r}
data_clean <- na.omit(data)
score(dag, data = data_clean, type = "bic")
score(dag, data = data_clean, type = "aic")
```

```{r}
arc.strength(dag, data = data_clean, criterion = "mi")
```

### Independencias (arcos no significativos)

$$
\begin{aligned}
& \text{sexo} \perp\!\!\!\perp \text{automovil} : 1.0000000 \\
& \text{estrato_alto} \perp\!\!\!\perp \text{automovil} : 1.0000000 \\
& \text{acto_religioso} \perp\!\!\!\perp \text{automovil} : 1.0000000 \\
& \text{destino} \perp\!\!\!\perp \text{automovil} : 1.0000000 \\
& \text{destino} \perp\!\!\!\perp \text{motorizado} : 1.0000000 \\
& \text{automovil} \perp\!\!\!\perp \text{dur_60} : 1.0000000 \\
& \text{motorizado} \perp\!\!\!\perp \text{dur_60} : 1.0000000 \\
\end{aligned}
$$

### Dependencias (arcos significativos)

$$
\begin{aligned}
& \text{sexo} \not\!\perp\!\!\!\perp \text{destino} : 8.65\times 10^{-163} \\
& \text{estrato_alto} \not\!\perp\!\!\!\perp \text{destino} : 3.40\times 10^{-80} \\
& \text{estrato_alto} \not\!\perp\!\!\!\perp \text{origen} : 1.84\times 10^{-265} \\
& \text{estrato_alto} \not\!\perp\!\!\!\perp \text{st_cuauh} : 6.67\times 10^{-313} \\
& \text{estrato_alto} \not\!\perp\!\!\!\perp \text{modo_ok} : 1.29\times 10^{-28} \\
& \text{acto_religioso} \not\!\perp\!\!\!\perp \text{destino} : 0.0000000 \\
& \text{destino} \not\!\perp\!\!\!\perp \text{es_sabado} : 0.0000000 \\
& \text{destino} \not\!\perp\!\!\!\perp \text{transporte_escolar} : 3.27\times 10^{-69} \\
& \text{origen} \not\!\perp\!\!\!\perp \text{st_cuauh} : 0.0000000 \\
& \text{origen} \not\!\perp\!\!\!\perp \text{modo_ok} : 9.31\times 10^{-10} \\
& \text{modo_ok} \not\!\perp\!\!\!\perp \text{dur_60} : 7.90\times 10^{-05} \\
\end{aligned}
$$
